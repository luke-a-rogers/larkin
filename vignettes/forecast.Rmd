---
title: "forecast"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{forecast}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(larkin)
```

```{r data}
# Define
span <- 100
beta <- c(-8, -6, -4, -2)
gamma <- c(0.1, 0.2, 0.3)

# Environmental covariates
covars <- simulate_environmental_covariates(span, rep(0, 3), 0.5, 1)

# Simulation
s <- sim(
  alpha = 2,
  beta = beta,
  init = rep(0.1, 8),
  p_bar = c(0.003, 0.917, 0.08),
  phi = 0,
  sigma = 0.1,
  burn = 100,
  span = span,
  harvest = 0.2,
  gamma = gamma,
  # gamma = NULL,
  covars = covars,
  # covars = NULL,
  extirp = 1e-6
)

# Data list
data <- list(
  B = 4,
  # G = 0,
  G = 3,
  N = span,
  # environs = matrix(0, 0, 0),
  environs = as.matrix(covars),
  recruits = s$r_4,
  spawners = s$spawners,
  mu_alpha = 2,
  mu_beta = beta,
  # mu_gamma = numeric(0),
  mu_gamma = gamma,
  mu_sigma = 0.5,
  sd_alpha = 0.5,
  sd_beta = abs(beta) * 0.1,
  # sd_gamma = numeric(0),
  sd_gamma = abs(gamma) * 0.1,
  sd_sigma = 0.3,
  fudge = 1e-12
)

```

```{r forecast}
# Only fit if cmdstan installed
if (!is.null(cmdstanr::cmdstan_version(error_on_NA = FALSE))) {
  # fit
  f1 <- forecast(
    data = data,
    index = 75,
    buffer = 10,
    metric = "mamse",
    beyond = FALSE,
    cores = NULL,
    chains = 1,
    step_size = 0.01,
    iter_warmup = 500,
    iter_sampling = 1000
  )
  tibble::view(f1)
}

```
